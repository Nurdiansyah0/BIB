{% extends "base.html" %}
{% block title %}Admin - Import Database{% endblock %}

{% block content %}
<div class="card">
  <h2>Import Database (Superuser)</h2>
  <p class="note">Unggah file <strong>.xlsx</strong> atau <strong>.csv</strong> untuk preview, lalu commit ke database.</p>

  <form id="uploadForm">
    <div class="row">
      <label for="file">Pilih File</label>
      <input type="file" id="file" name="file" accept=".xlsx,.xls,.csv" required />
    </div>

    <div class="row">
      <label for="terminal_name">Nama Terminal</label>
      <input type="text" id="terminal_name" name="terminal_name" placeholder="mis. Terminal 1" required />
    </div>

    <div class="row">
      <label for="mode">Mode</label>
      <select id="mode" name="mode">
        <option value="create_or_update">Buat baru / perbarui</option>
        <option value="update_only">Hanya perbarui</option>
      </select>
    </div>

    <div class="row">
      <label><input type="checkbox" id="insert_rows" /> Sekaligus seed baris ke tabel inspections</label>
      <div class="note">Jika dicentang, setiap baris pada file akan disimpan ke tabel <code>inspections</code> (kolom disimpan di field JSON <code>data</code>).</div>
    </div>

    <div class="actions">
      <button type="submit" class="btn">Upload &amp; Preview</button>
      <span id="status" class="status"></span>
    </div>
  </form>

  <hr style="border-color:rgba(255,255,255,.3);margin:16px 0;">

  <div id="previewWrap" style="display:none;">
    <h3>Preview Data</h3>
    <p class="note"><span id="fileInfo"></span></p>
    <div style="overflow:auto; max-height:420px; border:1px solid rgba(255,255,255,.25); border-radius:8px;">
      <table id="previewTable" style="width:100%; border-collapse:collapse; background:#fff; color:#333;">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>

    <h3 style="margin-top:16px;">Preview form_schema</h3>
    <pre id="schemaBox" style="background:#111;color:#0f0;padding:10px;border-radius:8px;overflow:auto;max-height:300px;"></pre>

    <div class="actions">
      <button id="commitBtn" class="btn">Commit ke Database</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const statusEl = document.getElementById('status');
const form = document.getElementById('uploadForm');
const previewWrap = document.getElementById('previewWrap');
const previewTable = document.getElementById('previewTable');
const schemaBox = document.getElementById('schemaBox');
const fileInfo = document.getElementById('fileInfo');

let IMPORT_TOKEN = null;

function setStatus(msg, ok=false){
  statusEl.style.color = ok ? 'lime' : 'yellow';
  statusEl.textContent = msg;
}

function renderTable(columns, rows){
  const thead = previewTable.querySelector('thead');
  const tbody = previewTable.querySelector('tbody');
  thead.innerHTML = ''; tbody.innerHTML = '';

  const trh = document.createElement('tr');
  columns.forEach(col => {
    const th = document.createElement('th');
    th.textContent = col;
    th.style.borderBottom = '1px solid #ccc';
    th.style.textAlign = 'left';
    th.style.padding = '6px 8px';
    trh.appendChild(th);
  });
  thead.appendChild(trh);

  rows.forEach(r => {
    const tr = document.createElement('tr');
    columns.forEach(c => {
      const td = document.createElement('td');
      td.textContent = r[c] ?? '';
      td.style.borderBottom = '1px solid #eee';
      td.style.padding = '6px 8px';
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  setStatus('Mengunggah & memproses file...');
  previewWrap.style.display = 'none';
  IMPORT_TOKEN = null;

  const fd = new FormData(form);
  const insertRows = document.getElementById('insert_rows').checked; // hanya untuk commit nanti
  try {
    const res = await fetch('/api/admin/import-xlsx', { method: 'POST', body: fd });
    const data = await res.json();
    if(!res.ok) throw new Error(data.detail || 'Gagal memproses file');

    IMPORT_TOKEN = data.token;
    setStatus('Preview siap.', true);

    fileInfo.textContent = `${data.filename} â€” ${data.row_count} baris`;
    renderTable(data.columns, data.preview);
    schemaBox.textContent = JSON.stringify(data.schema, null, 2);
    previewWrap.style.display = 'block';
  } catch (err) {
    setStatus(String(err.message || err), false);
  }
});

document.getElementById('commitBtn').addEventListener('click', async () => {
  if(!IMPORT_TOKEN){ setStatus('Belum ada preview untuk di-commit.'); return; }
  setStatus('Menyimpan ke database...');
  const terminal_name = document.getElementById('terminal_name').value.trim();
  const mode = document.getElementById('mode').value;
  const insert_rows = document.getElementById('insert_rows').checked;

  const fd = new FormData();
  fd.append('token', IMPORT_TOKEN);
  fd.append('terminal_name', terminal_name);
  fd.append('mode', mode);
  fd.append('insert_rows', insert_rows ? 'true' : 'false');

  try {
    const res = await fetch('/api/admin/commit-import', { method:'POST', body: fd });
    const data = await res.json();
    if(!res.ok) throw new Error(data.detail || 'Gagal menyimpan');
    setStatus(`Berhasil: terminal_id=${data.terminal_id}, inserted_rows=${data.inserted_rows}`, true);
  } catch (err) {
    setStatus(String(err.message || err), false);
  }
});
</script>
{% endblock %}
