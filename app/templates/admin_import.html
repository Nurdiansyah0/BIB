{% extends "base.html" %}
{% block title %}Admin - Import Database{% endblock %}

{% block content %}
<div class="card">
  <div class="actions" style="justify-content:flex-end; margin-bottom:6px;">
    <a class="btn" href="/dashboard">Kembali ke Dashboard</a>
  </div>
  <h2>Import Database (Superuser)</h2>
  <p class="note">Unggah file <strong>.xlsx</strong> atau <strong>.csv</strong> untuk preview, lalu commit ke database.</p>

  <form id="uploadForm">
    <div class="row">
      <label for="file">Pilih File</label>
      <input type="file" id="file" name="file" accept=".xlsx,.xls,.csv" required />
    </div>

    <div class="row">
      <label for="terminal_name">Nama Terminal</label>
      <input type="text" id="terminal_name" name="terminal_name" placeholder="mis. Terminal 1" required />
    </div>

    <div class="row">
      <label for="mode">Mode</label>
      <select id="mode" name="mode">
        <option value="create_or_update">Buat baru / perbarui</option>
        <option value="update_only">Hanya perbarui</option>
      </select>
    </div>

    <div class="row">
      <label>Relasi (opsional)</label>
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:flex-end;">
        <div>
          <div style="font-size:12px;opacity:.9;">Default Inspector</div>
          <select id="default_inspector" style="min-width:220px;"></select>
        </div>
        <div>
          <div style="font-size:12px;opacity:.9;">Kolom Username Inspector</div>
          <input type="text" id="inspector_username_col" placeholder="mis. inspector_username" style="min-width:220px;" />
        </div>
      </div>
      <div class="note">Jika diisi, setiap baris akan mencoba mencari user dari kolom tersebut. Jika tidak ditemukan, akan menggunakan Default Inspector.</div>
    </div>

    <div class="row">
      <label><input type="checkbox" id="insert_rows" /> Sekaligus seed baris ke tabel inspections</label>
      <div class="note">Jika dicentang, setiap baris pada file akan disimpan ke tabel <code>inspections</code> (kolom disimpan di field JSON <code>data</code>).</div>
    </div>

    <div class="actions">
      <button type="submit" class="btn">Upload &amp; Preview</button>
      <span id="status" class="status"></span>
    </div>
  </form>

  <hr style="border-color:rgba(255,255,255,.3);margin:16px 0;">

  <div id="previewWrap" style="display:none;">
    <h3>Preview Data</h3>
    <p class="note"><span id="fileInfo"></span></p>
    <div style="overflow:auto; max-height:420px; border:1px solid rgba(255,255,255,.25); border-radius:8px;">
      <table id="previewTable" style="width:100%; border-collapse:collapse; background:#fff; color:#333;">
        <thead></thead>
        <tbody></tbody>
      </table>
    </div>

    <h3 style="margin-top:16px;">Preview form_schema</h3>
    <pre id="schemaBox" style="background:#111;color:#0f0;padding:10px;border-radius:8px;overflow:auto;max-height:300px;"></pre>

    <div class="actions">
      <button id="commitBtn" class="btn">Commit ke Database</button>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const statusEl = document.getElementById('status');
const form = document.getElementById('uploadForm');
const previewWrap = document.getElementById('previewWrap');
const previewTable = document.getElementById('previewTable');
const schemaBox = document.getElementById('schemaBox');
const fileInfo = document.getElementById('fileInfo');
const uploadBtn = form.querySelector('button[type="submit"]');
const commitBtn = document.getElementById('commitBtn');
const defaultInspector = document.getElementById('default_inspector');

async function loadInspectors(){
  defaultInspector.innerHTML = '<option value="">(pakai akun saya)</option>';
  try{
    const res = await fetch('/api/admin/users');
    const list = await res.json();
    if(Array.isArray(list)){
      list.forEach(u=>{
        const o = document.createElement('option');
        o.value = u.id; o.textContent = `${u.username} (#${u.id})`;
        defaultInspector.appendChild(o);
      });
    }
  }catch(e){ /* ignore */ }
}

let IMPORT_TOKEN = null;

function setStatus(msg, ok=false){
  statusEl.style.color = ok ? 'lime' : 'yellow';
  statusEl.textContent = msg;
  try { notify(msg, ok ? 'success' : 'warn'); } catch(_) {}
}

function canAccept(filename){
  const allowed = ['.csv','.xlsx','.xls'];
  const ext = (filename||'').toLowerCase().slice(((filename||'').lastIndexOf('.')));
  return allowed.includes(ext);
}

async function fetchSmart(url, opts){
  const res = await fetch(url, opts);
  let data = null;
  try { data = await res.json(); } catch(_) { data = { detail: await res.text().catch(()=>String(res.status)) }; }
  if(!res.ok){ throw new Error(data && (data.detail || data.message || String(res.status))); }
  return data;
}

function renderTable(columns, rows){
  const thead = previewTable.querySelector('thead');
  const tbody = previewTable.querySelector('tbody');
  thead.innerHTML = ''; tbody.innerHTML = '';

  const trh = document.createElement('tr');
  columns.forEach(col => {
    const th = document.createElement('th');
    th.textContent = col;
    th.style.borderBottom = '1px solid #ccc';
    th.style.textAlign = 'left';
    th.style.padding = '6px 8px';
    trh.appendChild(th);
  });
  thead.appendChild(trh);

  rows.forEach(r => {
    const tr = document.createElement('tr');
    columns.forEach(c => {
      const td = document.createElement('td');
      td.textContent = r[c] ?? '';
      td.style.borderBottom = '1px solid #eee';
      td.style.padding = '6px 8px';
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

form.addEventListener('submit', async (e) => {
  e.preventDefault();
  const fileEl = document.getElementById('file');
  const f = fileEl.files && fileEl.files[0];
  if(!f){ setStatus('Pilih file terlebih dahulu.'); return; }
  if(!canAccept(f.name)) { setStatus('Format tidak didukung. Gunakan .csv atau .xlsx/.xls'); return; }
  setStatus('Mengunggah & memproses file...');
  previewWrap.style.display = 'none';
  IMPORT_TOKEN = null;

  uploadBtn.disabled = true; commitBtn.disabled = true;
  const fd = new FormData(form);
  try {
    const data = await fetchSmart('/api/admin/import-xlsx', { method: 'POST', body: fd });

    IMPORT_TOKEN = data.token;
    setStatus('Preview siap.', true);

    fileInfo.textContent = `${data.filename} â€” ${data.row_count} baris`;
    renderTable(data.columns, data.preview);
    schemaBox.textContent = JSON.stringify(data.schema, null, 2);
    previewWrap.style.display = 'block';
  } catch (err) {
    setStatus(String(err.message || err), false);
  } finally {
    uploadBtn.disabled = false; commitBtn.disabled = false;
  }
});

document.getElementById('commitBtn').addEventListener('click', async () => {
  if(!IMPORT_TOKEN){ setStatus('Belum ada preview untuk di-commit.'); return; }
  setStatus('Menyimpan ke database...');
  const terminal_name = document.getElementById('terminal_name').value.trim();
  const mode = document.getElementById('mode').value;
  const insert_rows = document.getElementById('insert_rows').checked;

  const fd = new FormData();
  fd.append('token', IMPORT_TOKEN);
  fd.append('terminal_name', terminal_name);
  fd.append('mode', mode);
  fd.append('insert_rows', insert_rows ? 'true' : 'false');
  const defInsp = defaultInspector.value;
  if(defInsp) fd.append('default_inspector_id', defInsp);
  const inspCol = document.getElementById('inspector_username_col').value.trim();
  if(inspCol) fd.append('inspector_username_col', inspCol);

  try {
    commitBtn.disabled = true; uploadBtn.disabled = true;
    const data = await fetchSmart('/api/admin/commit-import', { method:'POST', body: fd });
    setStatus(`Berhasil: terminal_id=${data.terminal_id}, inserted_rows=${data.inserted_rows}`, true);
  } catch (err) {
    setStatus(String(err.message || err), false);
  } finally {
    commitBtn.disabled = false; uploadBtn.disabled = false;
  }
});

// Initial loads
loadInspectors();
</script>
{% endblock %}
