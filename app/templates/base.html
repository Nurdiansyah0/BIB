<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{% block title %}Hang Nadim{% endblock %}</title>
  <link rel="stylesheet" href="/static/app.css">  <!-- PENTING -->
  {% block head_extra %}{% endblock %}
</head>
<body>
  <div class="bg"></div>
  <header class="topbar">
    <div class="topbar-inner">
      <a class="brand" href="/dashboard">BIB</a>
      <nav id="nav-links" class="links">
        <!-- Filled by script -->
      </nav>
    </div>
  </header>
  <main class="page">
    {% block content %}{% endblock %}
  </main>
  <script>
    (async function(){
      const el = document.getElementById('nav-links');
      if(!el) return;
      function set(html){ el.innerHTML = html; }
      try{
        const res = await fetch('/api/me');
        if(!res.ok) throw new Error('not ok');
        const me = await res.json();
        if(me && me.username){
          const r = (me.role||'').toLowerCase().replace('_',' ');
          const canDash = ['team leader','manager','group head','administrator','superadmin'].includes(r);
          const isAdmin = r === 'superadmin' || r === 'administrator';
          set(`
            ${canDash ? '<a href="/dashboard">Dashboard</a>' : ''}
            <a href="/inspection-form">Form Inspeksi</a>
            <a href="/inspections">Daftar Inspeksi</a>
            ${isAdmin ? '<a href="/admin/manage">Admin</a><a href="/admin/import">Import</a>' : ''}
            <span class="sep"></span>
            ${canDash ? '<a href="/users">Users</a>' : ''}
            <a href="/account">Akun</a>
            <span class="who">${me.username} (${me.role})</span>
            <a href="/logout">Keluar</a>
          `);
        } else {
          set(`<a href="/">Login</a>`);
        }
      }catch(e){
        set(`<a href="/">Login</a>`);
      }
    })();
  </script>
  <style>
    .toast-container{position:fixed; right:16px; top:64px; z-index:9999; display:flex; flex-direction:column; gap:8px}
    .toast{min-width:260px; max-width:420px; padding:10px 12px; border-radius:8px; color:#fff; box-shadow:0 8px 24px rgba(0,0,0,.25); opacity:.98; display:flex; align-items:flex-start; gap:8px}
    .toast-info{background:#0072BC}
    .toast-success{background:#2e7d32}
    .toast-warn{background:#f9a825}
    .toast-error{background:#c62828}
    .toast .close{margin-left:auto; cursor:pointer; opacity:.9}
  </style>
  <div id="toast-root" class="toast-container" aria-live="polite" aria-atomic="true"></div>
  <script>
    (function(){
      const root = document.getElementById('toast-root');
      function showToast(message, type='info', ms=3000){
        if(!root) return;
        const div = document.createElement('div');
        div.className = 'toast toast-' + (type==='error'?'error':type==='success'?'success':type==='warn'?'warn':'info');
        const span = document.createElement('span');
        span.textContent = message;
        const btn = document.createElement('span'); btn.textContent='âœ•'; btn.className='close'; btn.onclick=remove;
        function remove(){ if(div.parentNode){ div.parentNode.removeChild(div);} }
        div.appendChild(span); div.appendChild(btn); root.appendChild(div);
        if(ms>0){ setTimeout(remove, ms); }
      }
      window.toast = Object.assign(showToast, {
        info: (m,ms)=>showToast(m,'info',ms||3000),
        success: (m,ms)=>showToast(m,'success',ms||2500),
        warn: (m,ms)=>showToast(m,'warn',ms||3500),
        error: (m,ms)=>showToast(m,'error',ms||5000),
      });
      // Minimal wrapper alias
      window.notify = function(message, type='info', ms){
        try{
          if(type==='success') return toast.success(message, ms);
          if(type==='warn' || type==='warning') return toast.warn(message, ms);
          if(type==='error' || type==='danger') return toast.error(message, ms);
          return toast.info(message, ms);
        }catch(_){ /* no-op */ }
      }
    })();
  </script>
  {% block scripts %}{% endblock %}
</body>
</html>
